<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Generator (DEBUG MODE)</title>
    
    <script>
        window.onerror = function(msg, url, line) {
            alert("FEHLER: " + msg + "\nZeile: " + line);
            return false;
        };
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    
    <style>
        body { font-family: sans-serif; background: #222; color: #fff; padding: 20px; }
        button { padding: 15px; width: 100%; font-size: 1.2rem; margin-top: 10px; cursor: pointer; }
        input { padding: 10px; width: 100%; box-sizing: border-box; margin-top: 5px; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <h1>üîß Diagnose Modus</h1>
    
    <div id="status" style="border:1px solid yellow; padding:10px; margin-bottom:10px; color:yellow;">
        Warte auf Start...
    </div>

    <label>Von:</label><input type="date" id="date-start">
    <label>Bis:</label><input type="date" id="date-end">
    <label>Code:</label><input type="password" id="api-pw" placeholder="Code...">
    
    <button id="btn-load">üöÄ Daten Laden (Test)</button>
    
    <div id="result-area" class="hidden" style="margin-top:20px; border-top:1px solid #fff;">
        <h3>Ergebnis:</h3>
        <pre id="output">...</pre>
        <button id="btn-pdf">üñ®Ô∏è PDF Testen</button>
    </div>

    <script>
        // Check ob Libraries da sind
        if (typeof pdfMake === 'undefined') {
            alert("KRITISCH: pdfMake wurde nicht geladen! Checken Sie Ihre Internetverbindung oder Adblocker.");
            document.getElementById('status').innerText = "Bibliothek fehlt!";
        } else {
            document.getElementById('status').innerText = "System Bereit.";
        }

        const API_URL = "https://script.google.com/macros/s/AKfycbxpMRFvRHGDeDGLtKu6Q8lHAXnd75Mq4Je3gpZTY30dyIUFBhUq7ecqs7yjp7Qw3iVM/exec"; 

        // Init
        const now = new Date();
        document.getElementById('date-start').valueAsDate = new Date(now.getFullYear(), now.getMonth(), 1);
        document.getElementById('date-end').valueAsDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        
        // PW laden
        const storedPW = localStorage.getItem('reporter_pw');
        if(storedPW) document.getElementById('api-pw').value = storedPW;

        document.getElementById('btn-load').addEventListener('click', async () => {
            alert("Button geklickt! Starte..."); // Lebenszeichen
            
            const btn = document.getElementById('btn-load');
            const pw = document.getElementById('api-pw').value;
            const sDate = document.getElementById('date-start').value;
            const eDate = document.getElementById('date-end').value;

            if(!pw) return alert("Kein Passwort!");
            localStorage.setItem('reporter_pw', pw);

            btn.innerText = "Sende Anfrage an Google...";
            
            try {
                // Fetch starten
                const res = await fetch(API_URL, {
                    method: "POST",
                    body: JSON.stringify({ 
                        password: pw,
                        startDate: sDate,
                        endDate: eDate
                    })
                });
                
                btn.innerText = "Antwort erhalten. Parse JSON...";
                const json = await res.json();

                if (json.result === "success") {
                    alert("Erfolg! " + json.data.length + " Datens√§tze.");
                    document.getElementById('output').innerText = JSON.stringify(json.meta, null, 2);
                    document.getElementById('result-area').classList.remove('hidden');
                    // Globale Variable f√ºr PDF speichern
                    window.reportData = json.data;
                    window.reportMeta = json.meta;
                } else {
                    alert("Server Fehler: " + json.message);
                }
            } catch (e) {
                alert("CRASH: " + e.message);
            } finally {
                btn.innerText = "üöÄ Daten Laden (Test)";
            }
        });

        document.getElementById('btn-pdf').addEventListener('click', () => {
            try {
                const data = window.reportData || [];
                const meta = window.reportMeta || {};
                
                const docDefinition = {
                    content: [
                        { text: 'Diagnose PDF', style: 'header' },
                        { text: 'Name aus DB: ' + (meta.name || 'fehlt') },
                        { text: 'Anzahl Schichten: ' + data.length }
                    ]
                };
                pdfMake.createPdf(docDefinition).download('test.pdf');
                alert("PDF Download gestartet.");
            } catch(e) {
                alert("PDF Fehler: " + e.message);
            }
        });
    </script>
</body>
</html>
